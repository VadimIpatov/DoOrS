DoOrS
=====

Simple i386 OS with partial DOS API
-----------------------------------


Операционная система DoOrS
--------------------------

Аппаратные требования 
---------------------

IBM-PC совместимый компьютер, CGA, клавиатура.


Описание
--------
DoOrS представляет собой однозадачную однопользовательскую частично совместимую с DOS на уровне исполняемых файлов и ФС операционную систему реального режима. DoOrS состоит из 2 независимых частей: загрузчик и ядро. 
DoOrS позволяет исполнять программы в COM-формате, написанные для MS-DOS младших версий. Совместимость наличествует только на уровне прерывания 0x21 и способе загрузки и выгрузки процесса в память/из памяти. 



Загрузчик
---------

После окончания начальной загрузки программа POST находит активное устройство и загружает с него короткую программу загрузки ОС - загрузочный сектор. Загрузочный сектор это первый физический сектор устройства, в данном случае дискеты, и его размер равен составляет 512 байт. С помощью этих 512 байт мы считываем с дискеты ядро ОС, загружаем его в память и передаём управление. Заголовок файловой системы FAT находится в первом секторе дискеты, благодаря чему этот заголовок, содержащий всю необходимую информацию о файловой системе, загружается вместе с загрузчиком. 

В связи с тем, что размер загрузчика не может превышать 512 байт, наши возможности несколько ограничены и приходится идти на некоторые упрощения. В частности: учитывая то, что первый файл, записанный на чистый FAT ВСЕГДА хранится в 33 секторе, все операции с диском сводятся к переводу логических характеристик диска в физические и считыванию 64 кб ядра; также пришлось понизить информативность выводимых загрузчиком сообщений.
Также предусмотрена проверка на наличие ядра в корневом каталоге ФС путём сравнения сигнатуры, находящейся в самом начале ядра c 0xABCD. Для демонстрации возможности работы с графическими адаптерами в загрузчик также встроена примитивная заставка, имитирующая процесс загрузки.

В процессе загрузки могут возникнуть следующие ошибки:
RE (ReadError) – Ошибка чтения. Может возникнуть из-за дефектных секторов на дискете, неисправности дисковода и, возможно, по каким-либо другим причинам.
Krnl? - Не найдено ядро. Причиной возникновения может служить отсутствие ядра, ядро записанное на «не чистый» FAT (т.е. не первым файлом), либо на месте ядра находится другой файл.



Ядро
----

Ядро DoOrS предоставляет командный пользовательский интерфейс (CLI), менеджер процессов, файловую систему FAT12 и некоторый API (частично реализованное прерывание 0x21, системные вызовы). Также ядро при загрузке выводит некоторую информацию о системе (тип компьютера, дату BIOS).

Командный интерфейс
-------------------
После загрузки ядра управление передаётся командному интерпретатору. Именно с его помощью пользователь может обращаться к функциям операционной системы путём ввода команд. Первое, что увидит пользователь после загрузки – это системное приглашение:
A:\>
Оно отображает текущую директорию и служит сигналом к тому, что ОС готова принимать команды.
Команды – встроенные микропрограммы ОС или прикладное ПО, загружаемое с диска.
Когда пользователь вводит команду, ОС ищет её сначала среди встроенных (buil-in) команд, затем, если не находит, производит поиск по текущей директории в поиске файла с именем
«команда_пользователя.com». Если команда не найдена, пользователь получит сообщение «No such command». DoOrS не делает различий в регистре. Поэтому команды help
и HELP и означают одно и то же. Также игнорируются пробелы в конце команды.

Встроенные команды:
CD – Перемещение по ФС
CLS – Очищает экран
COLOR – Изменяет цвет выводимых на экран символов
DINFO – Информация из загрузочного сектора
DIR – Выводит содержимое текущей директории
EXEC – Исполнение программ
HELP – Выводит информацию о доступных командах
PWD – Выводит текущую директорию
SHUTDOWN – Завершает работу
VER – Выводит информацию о версии DoOrS

Отдельно следует остановиться на возможностях команды SHUTDOWN.
После её вызова пользователю будет задан вопрос «[R]eboot/Re[L]oad/[H]alt or [C]ancel?»
Выбор соответствующего пункта осуществляется путём нажатия на клавишу, выделенную квадратными скобками.
R – Полная перезагрузка компьютера
L – Перезагрузка с пропуском процедуры POST
H – Остановка процессора
C – Возврат в командную строку
 

Менеджер процессов
------------------
DoOrS – однозадачная ОС, поэтому в задачи менеджера процессов входит лишь загрузка программы с диска в память, настройка PSP, сохранение адреса возврата, передача управления процессу и корректное его завершение.


Файловая система
----------------
В DoOrS реализована поддержка FAT12.

Доступны следующие функции прерывания 0x21:
0x00 - Завершение программы
0x01 - Ввод с клавиатуры
0x02 - Вывод на дисплей
0x08 - Ввод с клавиатуры без эха
0x09 - Выдать строку на дисплей
0x0A - Ввод строки в буфер
0x18 - DOS Null-function
0x25 - Установить вектор прерывания
0x30 - Получить версию ОС
0x35 - Получить вектор прерывания
0x39 - Создать директорию (для совместимости)
0x3A - Удалить директорию (для совместимости)
0x3B - Сменить директорию (для совместимости)
0x3C - Создать файл (для совместимости)
0x3D - Открыть директорию (для совместимости)
0x3E - Закрыть файл (для совместимости)
0x41 - Удалить файл (для совместимости)
0x4C - Завершение программы

Следует заметить, что функции 0x39..0x41 выполнены в качестве заглушек и не вносят никакой функциональности. Они всегда возвращают ошибку.

Более подробную информацию по данным функциям можно получить из «Dos Technical Reference».

Системные вызовы DoOrS предоставляют некоторые функции работы с дисплеем, системным динамиком, ввода/вывода, обработки строк. Для их использования в прикладной программе необходимо подключить соответствующие заголовочные файлы.


Замечания по сборке и загрузке
------------------------------

Сборка:
Для разработки проекта был выбран компилятор NASM по нескольким причинам:
1.	Умеет создавать чистые бинарные файлы.
2.	Имеет версии под многие ОС (в том числе под Unix и Windows).
3.	Имеет привычный синтаксис Intel.

Для упрощения процесса отладки и ускорения сборки был написан Makefile, поддерживающий следующие режимы:

•	all – компиляция всех модулей, создание пустого FAT, запись ядра на FAT.
•	boot – запись загрузочного сектора на дискету.
•	kern – копирование ядра на дискету.
•	vboot – запись загрузчика в образ.
•	vkern – запись ядра в образ.
•	clean – удаление созданных файлов (*.bin и *.ima)

Следует отметить режим vboot – для его реализации была написана небольшая программа на СИ «bootwrite», находящаяся в src/bootwrite. Она принимает 2 параметра: файл с загрузочным сектором и файл-образ. Программа не зависит от платформы.

Данный способ сборки был описан для системы Windows. Пользователи Unix также без труда могут скомпилировать все модули и записать их на диск или образ штатными средствами, также необходима небольшая правка Makefile и исходных текстов ввиду различий в формировании пути между этими ОС: в Windows используется «\», в Unix - «/».

Загрузка:
Возможны 2 варианта загрузки ОС: загрузка с дискеты или из образа.
Во втором случае для загрузки необходимо использовать средства виртуализации, доступные для Вашей ОС. Общие для Windows и для Unix (бесплатные): VMWare Player (конфигурация для него поставляется в пакете с DoOrS), Bochs, QEmu.

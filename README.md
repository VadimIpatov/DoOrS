DoOrS
=====

Simple i386 OS with partial DOS API
-----------------------------------


Операционная система DoOrS

Аппаратные требования: 
IBM-PC совместимый компьютер, CGA, клавиатура.

Описание:
	DoOrS представляет собой однозадачную однопользовательскую частично совместимую с DOS на уровне исполняемых файлов и ФС операционную систему реального режима. DoOrS состоит из 2 независимых частей: загрузчик и ядро. 
	DoOrS позволяет исполнять программы в COM-формате, написанные для MS-DOS младших версий. Совместимость наличествует только на уровне прерывания 0x21 и способе загрузки и выгрузки процесса в память/из памяти. 



Загрузчик

	После окончания начальной загрузки программа POST находит активное устройство и загружает с него короткую программу загрузки ОС - загрузочный сектор. Загрузочный сектор это первый физический сектор устройства, в данном случае дискеты, и его размер равен составляет 512 байт. С помощью этих 512 байт мы считываем с дискеты ядро ОС, загружаем его в память и передаём управление. Заголовок файловой системы FAT находится в первом секторе дискеты, благодаря чему этот заголовок, содержащий всю необходимую информацию о файловой системе, загружается вместе с загрузчиком. 

	В связи с тем, что размер загрузчика не может превышать 512 байт, наши возможности несколько ограничены и приходится идти на некоторые упрощения. В частности: учитывая то, что первый файл, записанный на чистый FAT ВСЕГДА хранится в 33 секторе, все операции с диском сводятся к переводу логических характеристик диска в физические и считыванию 64 кб ядра; также пришлось понизить информативность выводимых загрузчиком сообщений.
Также предусмотрена проверка на наличие ядра в корневом каталоге ФС путём сравнения сигнатуры, находящейся в самом начале ядра c 0xABCD. Для демонстрации возможности работы с графическими адаптерами в загрузчик также встроена примитивная заставка, имитирующая процесс загрузки.

	В процессе загрузки могут возникнуть следующие ошибки:
RE (ReadError) – Ошибка чтения. Может возникнуть из-за дефектных секторов на дискете, неисправности дисковода и, возможно, по каким-либо другим причинам.
Krnl? - Не найдено ядро. Причиной возникновения может служить отсутствие ядра, ядро записанное на «не чистый» FAT (т.е. не первым файлом), либо на месте ядра находится другой файл.



Ядро

	Ядро DoOrS предоставляет командный пользовательский интерфейс (CLI), менеджер процессов, файловую систему FAT12 и некоторый API (частично реализованное прерывание 0x21, системные вызовы). Также ядро при загрузке выводит некоторую информацию о системе (тип компьютера, дату BIOS).

Командный интерфейс:
	После загрузки ядра управление передаётся командному интерпретатору. Именно с его помощью пользователь может обращаться к функциям операционной системы путём ввода команд. Первое, что увидит пользователь после загрузки – это системное приглашение:
A:\>
Оно отображает текущую директорию и служит сигналом к тому, что ОС готова принимать команды.
	Команды – встроенные микропрограммы ОС или прикладное ПО, загружаемое с диска.
Когда пользователь вводит команду, ОС ищет её сначала среди встроенных (buil-in) команд, затем, если не находит, производит поиск по текущей директории в поиске файла с именем
«команда_пользователя.com». Если команда не найдена, пользователь получит сообщение «No such command». DoOrS не делает различий в регистре. Поэтому команды help
и HELP и означают одно и то же. Также игнорируются пробелы в конце команды.

Встроенные команды:
CD – Перемещение по ФС
CLS – Очищает экран
COLOR – Изменяет цвет выводимых на экран символов
DINFO – Информация из загрузочного сектора
DIR – Выводит содержимое текущей директории
EXEC – Исполнение программ
HELP – Выводит информацию о доступных командах
PWD – Выводит текущую директорию
SHUTDOWN – Завершает работу
VER – Выводит информацию о версии DoOrS

Отдельно следует остановиться на возможностях команды SHUTDOWN.
После её вызова пользователю будет задан вопрос «[R]eboot/Re[L]oad/[H]alt or [C]ancel?»
Выбор соответствующего пункта осуществляется путём нажатия на клавишу, выделенную квадратными скобками.
R – Полная перезагрузка компьютера
L – Перезагрузка с пропуском процедуры POST
H – Остановка процессора
C – Возврат в командную строку
 

Менеджер процессов:
	DoOrS – однозадачная ОС, поэтому в задачи менеджера процессов входит лишь загрузка программы с диска в память, настройка PSP, сохранение адреса возврата, передача управления процессу и корректное его завершение.


Файловая система:
В DoOrS реализована поддержка FAT12.

Загрузочный сектор FAT12 (0 сектор):
Смещение, байт	Размер, байт	Содержание
----------------------------------------
0	              3	            Команда JMP xxxxx - ближний переход на программу начальной загрузки
3	              8	            Название фирмы-изготовителя ОС и версия. 
11            	25	          Расширенный блок параметров BIOS
36	            1	            Физический номер устройства (0 - НГМД, 80h - НМД) 
37            	1	            Зарезервировано
38	            1	            Символ “(“- признак расширенной загрузочной записи
39	            4	            Серийный номер диска, создается во время форматирования
43	            11	          Метка диска
54	            8	            Содержит запись ‘FAT12 ‘ или ‘FAT16 ‘, которая идентифицирует формат таблицы размещения файлов (FAT) 

Со смещения 11  располагается расширенный блок параметров BIOS. Этот блок содержит некоторые характеристики логического диска. 
Смещение, байт	Размер, байт	Описание
--------------------------------------
0	              2	            Количество байт в одном секторе диска
2	              1	            Количество секторов в одном кластере
3             	2	            Количество зарезервированных секторов
5	              1	            Количество FAT
6	              2	            Максимальное количество дескрипторов файлов в корневом каталоге диска
8	              2	            Общее количество секторов на носителе данных
10	            1           	Байт-описатель среды носителя данных
11	            2	            Количество секторов, занимаемых одной копией FAT
13	            2	            Количество секторов на дорожке
15            	2	            Количество магнитных головок
17	            2	            Количество скрытых секторов, для носителя размером < 32 Мб
19	            2	            Количество скрытых секторов, для носителя размером > 32 Мб
21	            4	            Общее количество секторов на логическом диске, превышающим по размеру 32 Мб
 
Сразу вслед за загрузочным сектором на логическом диске находятся секторы, содержащие таблицу размещения файлов (FAT - таблица) . FAT - таблица используется для хранения информации о распределении файлам секторов диска. Сектор диска - это часть диска, в которой обычно хранится 512 байт информации, относящейся к файлу. Весь диск разбивается операционной системой на участки одинакового размера, называемые кластерами. Кластер может одержать несколько смежных секторов. Для каждого кластера в FAT таблице есть своя индивидуальная ячейка, в которой хранится информация об использовании кластера, т.е. FAT - таблица - это массив, содержащий информацию о кластерах. Размер этого массива равен общему количеству кластеров на логическом диске. 
В FAT - таблице находятся списки кластеров, распределенных файлам.. Таким образом, если файл занимает несколько кластеров на диске, то эти кластеры связаны в список. При этом элементы FAT - таблицы содержат номера следующих используемых данным файлом кластеров. Конец списка отмечен в таблице специальным значением. Номер первого кластера, распределенного файлу, хранится в элементе каталога, описывающего данный файл. Пример использования FAT таблицы приведен на рис. 

Корневой каталог диска C: 
Имя файла	    ... 	 Номер первого кластера, 
                     распределенного файлу
-----------------------------------------------------------------
autoexec. bat	... 	11 
config. sys	  ... 	12
... 	        ... 	... 

FAT - таблица
-----------------------------------------------------
... 	  17	13	FFFF	00	00	00	18	FFFF	00	..... 
кластер	11 	12	13	  14	15	16	17	18	  19	 

Первый байт FAT - таблицы называется описателем среды. Он имеет такое же значение, как и байт - описатель среды, находящийся в загрузочном секторе дика. 
Следующие 5 байт для 12-битового формата всегда содержат значение 0FFh. 

Остальная часть FAT таблицы состоит из 12 битовых ячеек. Каждая ячейка соответствует одному кластеру диска. Эти ячейки могут содержать следующие значения: 
FAT12	      Тип кластера
-----------------------------------------------------
000h	      Свободный кластер
FF0h-FF6h	  Зарезервированный кластер
FF7h	      Плохой кластер
FF8h-FFFh	  Последний кластер в списке
002h - FEFh	Номер следующего кластера в списке

Операционная система использует только первую копию FAT. 
Общая схема использования FAT такова 
Получаем номер первого кластера файла, для которого необходимо определить его расположение на диске. 
Используем номер первого кластера как индекс в FAT - таблице для извлечения номера следующего кластера. 
Повторяем предыдущую процедуру до тех пор, пока извлеченное из FAT - таблицы значение не будет соответствовать концу файла. 
Процедура извлечения номера кластера из FAT - таблицы зависит от формата FAT - таблицы. 
16-битовую FAT - таблицу можно представить как массив 16-битовых чисел. Для определения номера следующего кластера надо просто извлечь 16-битовое значение из FAT - таблицы, использовав в качестве индекса номер предыдущего кластера. 
Для 12-битовой FAT таблицы процедура значительно сложнее. Необходимо выполнить следующие действия: 

(Алгоритм Фролова):
•	умножить номер начального кластера на 3; 
•	разделить результат на 2; 
•	прочитать 16-битовое слово из FAT - таблицы, используя в качестве смещения значение, полученное после деления на 2; 
•	если номер начального кластера четный, на выбранное из FAT слово нужно наложить маску 0FFFh, оставив младшие 12 бит; если же номер начального кластера нечетный, выбранное из FAT значение необходимо сдвинуть вправо на 4 бита, оставив старшие 12 бит; 
•	полученный результат это номер следующего кластера в цепочке. 
•	Используя описанную выше процедуру можно определить для каждого файла цепочку занимаемых им кластеров. 
Для нахождения первого кластера, распределенного файлу необходимо прочитать информацию из каталога, в котором содержится данный файл. Для этого необходимо сначала прочитать корневой каталог, а затем все подкаталоги из пути каталогов к данному файлу. 
Корневой каталог находится сразу за последней копией FAT. Перед корневым каталогом находится один загрузочный сектор и 18 секторов FAT таблицы. Корневой каталог занимает непрерывную область фиксированного размера (с 19 по 32).  
Любой каталог одержит 32-байтовыу дескрипторы, описывающие файлы и другие каталоги. Дескриптор имеет следующий формат: 

Смещение, байт	Размер, байт	Содержание
-----------------------------------------
0	              8	            Имя файла или каталога, выровненное на левую границу и дополненное пробелами
8	              3	            Расширение имени файла, выровненное на левую границу и дополненное пробелами
11	            1	            Байт атрибутов файла
12	            10	          Зарезервировано
22	            2            	Время создания файла или время его последней модификации
24	            2	            Дата создания файла или дата его последней модификации
26	            2	            Номер первого кластера, распределенного файлу
28	            4	           Размер файла в байтах

Атрибуты файла: 
• 01h – Только чтение 
• 02h – Скрытый 
• 04h – Системный 
• 08h – Метка тома 
• 10h – Директория 
• 20h – Архив
В любом каталоге, кроме корневого, два первых дескриптора имеют специальное назначение. Первый дескриптор содержит в поле имени строку “.” . Этот дескриптор указывает на одержащий его каталог, т.е. каталог имеет ссылку на самого себя. 
Второй специальный дескриптор содержит в поле имени строку “..” . Это дескриптор указывает на каталог более высокого уровня Если в поле номера первого занимаемого кластера для дескриптора с именем “..” находится нулевое значение, это означает, что данный каталог содержится в корневом каталоге. 


Алгоритм расшифровки времени создания файла: 
And AX, 001Fh 
Imul AX, 2 
AX = секунды 

And AX, 07E0h 
Shr AX, 5 
AX = минуты

And AX, 0F800h 
Shr AX, 11 
AX = часы

Алгоритм расшифровки даты создания файла:  
And AX, 001Fh 
AX = день	 

And AX, 01E0h 
Shr AX, 5 
AX = месяц	

And AX, 0FC00h 
Shr AX, 9 
Add AX, 07BCh 
AX = год


API: 
	API (Application Programming Interface) ОС DoOrS – это частичная реализация прерывания 0x21 DOS-like операционных систем и некоторый набор системных вызовов.

Доступны следующие функции прерывания 0x21:
0x00 - Завершение программы
0x01 - Ввод с клавиатуры
0x02 - Вывод на дисплей
0x08 - Ввод с клавиатуры без эха
0x09 - Выдать строку на дисплей
0x0A - Ввод строки в буфер
0x18 - DOS Null-function
0x25 - Установить вектор прерывания
0x30 - Получить версию ОС
0x35 - Получить вектор прерывания
0x39 - Создать директорию (для совместимости)
0x3A - Удалить директорию (для совместимости)
0x3B - Сменить директорию (для совместимости)
0x3C - Создать файл (для совместимости)
0x3D - Открыть директорию (для совместимости)
0x3E - Закрыть файл (для совместимости)
0x41 - Удалить файл (для совместимости)
0x4C - Завершение программы

Следует заметить, что функции 0x39..0x41 выполнены в качестве заглушек и не вносят никакой функциональности. Они всегда возвращают ошибку.

Более подробную информацию по данным функциям можно получить из «Dos Technical Reference».

	Системные вызовы DoOrS предоставляют некоторые функции работы с дисплеем, системным динамиком, ввода/вывода, обработки строк. Для их использования в прикладной программе необходимо подключить соответствующие заголовочные файлы.


Замечания по сборке и загрузке

Сборка:
Для разработки проекта был выбран компилятор NASM по нескольким причинам:
1.	Умеет создавать чистые бинарные файлы.
2.	Имеет версии под многие ОС (в том числе под Unix и Windows).
3.	Имеет привычный синтаксис Intel.

Для упрощения процесса отладки и ускорения сборки был написан Makefile, поддерживающий следующие режимы:

•	all – компиляция всех модулей, создание пустого FAT, запись ядра на FAT.
•	boot – запись загрузочного сектора на дискету.
•	kern – копирование ядра на дискету.
•	vboot – запись загрузчика в образ.
•	vkern – запись ядра в образ.
•	clean – удаление созданных файлов (*.bin и *.ima)

Следует отметить режим vboot – для его реализации была написана небольшая программа на СИ «bootwrite», находящаяся в src/bootwrite. Она принимает 2 параметра: файл с загрузочным сектором и файл-образ. Программа не зависит от платформы.

Данный способ сборки был описан для системы Windows. Пользователи Unix также без труда могут скомпилировать все модули и записать их на диск или образ штатными средствами, также необходима небольшая правка Makefile и исходных текстов ввиду различий в формировании пути между этими ОС: в Windows используется «\», в Unix - «/».

Загрузка:
Возможны 2 варианта загрузки ОС: загрузка с дискеты или из образа.
Во втором случае для загрузки необходимо использовать средства виртуализации, доступные для Вашей ОС. Общие для Windows и для Unix (бесплатные): VMWare Player (конфигурация для него поставляется в пакете с DoOrS), Bochs, QEmu.
